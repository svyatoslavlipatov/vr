<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Audio Visualizer</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="aframe-audioanalyser-component.js"></script>
  <style>
    body { margin: 0; }
    a-scene { height: 100vh; }
  </style>
  <script>
   AFRAME.registerComponent('hover-effect', {
        init: function () {
          const el = this.el;
          let originalScale = Object.assign({}, el.getAttribute('scale'));  // Создание копии начального масштаба

          el.addEventListener('mouseenter', function () {
            originalScale = Object.assign({}, el.getAttribute('scale')); // Обновляем начальный масштаб перед увеличением
            el.setAttribute('scale', {
              x: originalScale.x * 1.2,
              y: originalScale.y * 1.2,
              z: originalScale.z * 1.2
            });
          });

          el.addEventListener('mouseleave', function () {
            el.setAttribute('scale', originalScale); // Возвращаем к исходному масштабу
          });

          el.addEventListener('click', function () {
            const audioId = el.getAttribute('audio-id');
            const audio = document.querySelector(`#${audioId}`);
            audio.play(); // Запускаем трек

            // Установка эквалайзера для текущего трека
            setEqualizer(audioId);
          });
        }
      });


    function setEqualizer(audioId) {
      const audio = document.getElementById(audioId);
      const analyserEntity = document.getElementById('equalizer');
      analyserEntity.setAttribute('audioanalyser', { src: `#${audioId}` });
      const analyser = analyserEntity.components.audioanalyser;

      if (analyser) {
        const visualizersCount = 75;
        const visualizers = document.querySelectorAll('.visualizer');

        setInterval(function () {
          const dataArray = new Uint8Array(analyser.analyser.frequencyBinCount);
          analyser.analyser.getByteFrequencyData(dataArray);
          const frequenciesPerBox = Math.floor(dataArray.length / visualizersCount);

          visualizers.forEach((visualizer, index) => {
            const start = index * frequenciesPerBox;
            const frequencySlice = dataArray.slice(start, start + frequenciesPerBox);
            const averageVolume = frequencySlice.reduce((acc, val) => acc + val, 0) / frequencySlice.length;

            const scaleY = 0.5 + averageVolume / 50;
            visualizer.setAttribute('scale', `0.5 ${scaleY} 0.5`);
            visualizer.setAttribute('position', `${visualizer.object3D.position.x} ${scaleY / 2} ${visualizer.object3D.position.z}`);
          });
        }, 10);
      } else {
        console.log("Аудиоанализатор не инициализирован.");
      }
    }

    function stopAllTracks() {
      const audios = document.querySelectorAll('audio');
      audios.forEach(audio => {
        audio.pause(); // Остановить трек
        audio.currentTime = 0; // Сбросить время трека
      });
    }
  </script>
</head>
<body>
  <a-scene>
    <a-light type="ambient" color="#222"></a-light>
    <a-light type="point" position="0 1 0" intensity="2"></a-light>
    <a-circle color="#333" opacity="0.8" rotation="-90 0 0" radius="12" roughness="1"></a-circle>
    <a-sky color="#222"></a-sky>

    <!-- Камера с управлением и курсором -->
    <a-entity id="camera" camera wasd-controls look-controls position="0 1.6 5">
      <a-cursor fuse="true" fuse-timeout="500" color="yellow"></a-cursor>
    </a-entity>

    <!-- Кнопка для остановки всех треков -->
    <a-entity position="0 1 -5" geometry="primitive: plane; width: 2; height: 1" material="color: red; opacity: 0.7" 
              text="value: Остановить все треки; align: center" 
              event-set__mouseenter="scale: 1.1 1.1 1.1"
              event-set__mouseleave="scale: 1 1 1"
              onclick="stopAllTracks()">
    </a-entity>

    <!-- Красная зона -->
    <a-box position="-8 0 -8" width="2" height="0.1" depth="2" color="#FF6347" animation="property: scale; to: 1.1 1.1 1.1; dir: alternate; dur: 2000; loop: true"></a-box>
    <a-cylinder position="-8 0.5 -8" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
    <a-plane id="cover-plane1" position="-8 1.25 -8" rotation="-35 40 0" width="1.5" height="1" material="side: double" src="#cover1" hover-effect scale="1 1 1" audio-id="song"></a-plane>
    <a-plane position="-8 0.01 -8" rotation="-90 0 0" width="4" height="4" color="#FF6347"></a-plane> <!-- Красный пол -->

    <!-- Зеленая зона -->
    <a-box position="8 0 -8" width="2" height="0.1" depth="2" color="#32CD32" animation="property: rotation; to: 0 360 0; dur: 5000; easing: linear; loop: true"></a-box>
    <a-cylinder position="8 0.5 -8" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
    <a-plane id="cover-plane2" position="8 1.25 -8" rotation="-45 -40 0" width="1.5" height="1" material="side: double" src="#cover2" hover-effect scale="1 1 1" audio-id="song2"></a-plane>
    <a-plane position="8 0.01 -8" rotation="-90 0 0" width="4" height="4" color="#32CD32"></a-plane> <!-- Зеленый пол -->

    <!-- Синяя зона -->
    <a-box position="-8 0 8" width="2" height="0.1" depth="2" color="#4682B4" animation="property: opacity; from: 0.5; to: 1; dur: 2000; loop: true"></a-box>
    <a-cylinder position="-8 0.5 8" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
    <a-plane id="cover-plane3" position="-8 1.25 8" rotation="-35 135 0" width="1.5" height="1" material="side: double" src="#cover3" hover-effect scale="1 1 1" audio-id="song3"></a-plane>
    <a-plane position="-8 0.01 8" rotation="-90 0 0" width="4" height="4" color="#4682B4"></a-plane> <!-- Синий пол -->

    <!-- Желтая зона -->
    <a-box position="8 0 8" width="2" height="0.1" depth="2" color="#FFD700" animation="property: position; to: 8 0.2 8; dur: 1000; dir: alternate; loop: true"></a-box>
    <a-cylinder position="8 0.5 8" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
    <a-plane id="cover-plane4" position="8 1.25 8" rotation="-35 215 0" width="1.5" height="1" material="side: double" src="#cover4" hover-effect scale="1 1 1" audio-id="song4"></a-plane>
    <a-plane position="8 0.01 8" rotation="-90 0 0" width="4" height="4" color="#FFD700"></a-plane> <!-- Желтый пол -->

    <!-- Ассеты -->
    <a-assets>
      <img id="cover1" src="pic/cover1.png">
      <img id="cover2" src="pic/cover2.png">
      <img id="cover3" src="pic/cover3.png">
      <img id="cover4" src="pic/cover4.png">
      <audio id="song" src="music/track1.mp3"></audio>
      <audio id="song2" src="music/track2.mp3"></audio>
      <audio id="song3" src="music/track3.mp3"></audio>
      <audio id="song4" src="music/track4.mp3"></audio>
      <audio id="clickSound" src="music/click.mp3"></audio>
    </a-assets>

    <!-- эквалайзер -->
    <a-entity id="equalizer" position="0 0 4">
      <!-- кубы создаются динамически через JavaScript -->
    </a-entity>

    <script>
      const equalizer = document.getElementById('equalizer');
      const visualizersCount = 75;
      const radius = 15; 

      // генерация случайного цвета
      function getRandomColor() {
        return `#${Math.floor(Math.random() * 16777215).toString(16)}`;
      }

      for (let i = 0; i < visualizersCount; i++) {
        const angle = (Math.PI / (visualizersCount - 1)) * i;
        const x = radius * Math.cos(angle);
        const z = radius * Math.sin(angle);
        const visualizer = document.createElement('a-box');

        visualizer.classList.add('visualizer');
        visualizer.setAttribute('scale', '0.5 0.1 0.5'); 
        visualizer.setAttribute('position', `${x} 0 ${z}`);
        visualizer.setAttribute('material', 'color', getRandomColor());
        equalizer.appendChild(visualizer);
      }
    </script>
  </a-scene>
</body>
</html>
